name: Multi-Folder Sync

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:

jobs:
  sync-folders:
    runs-on: ubuntu-latest
    env:
      # é…ç½®æ¯ä¸ªæ–‡ä»¶å¤¹çš„ç›®æ ‡ä»“åº“å’Œåˆ†æ”¯: æ–‡ä»¶å¤¹,ä»“åº“,åˆ†æ”¯
      FOLDER_REPO: |
        folderA,ç”¨æˆ·å/repoA,main
        folderB,ç”¨æˆ·å/repoB,main
        folderC,ç”¨æˆ·å/repoC,main

      # ä¸Šæ¸¸ä»“åº“åœ°å€å’Œåˆ†æ”¯ï¼ˆå¦‚æœæœ‰ä¸Šæ¸¸éœ€è¦åŒæ­¥ï¼‰
      UPSTREAM_REPO: https://github.com/åŸä½œè€…ç”¨æˆ·å/åŸé¡¹ç›®å.git
      UPSTREAM_BRANCH: main

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: é…ç½® git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è·å–ä¸Šæ¸¸æœ€æ–°å†…å®¹
        run: |
          git remote add upstream $UPSTREAM_REPO || echo "â„¹ï¸ ä¸Šæ¸¸å·²å­˜åœ¨"
          git fetch upstream

      - name: åŒæ­¥æ¯ä¸ªæ–‡ä»¶å¤¹
        run: |
          while IFS=',' read -r folder repo branch; do
            echo "ğŸ”„ å¼€å§‹åŒæ­¥ $folder åˆ°ä»“åº“ $repo åˆ†æ”¯ $branch"

            cd $folder || continue

            # åˆå§‹åŒ– gitï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
            if [ ! -d .git ]; then
              git init
              git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$repo.git
            fi

            # åŒæ­¥ä¸Šæ¸¸ï¼ˆå¿½ç•¥åˆ é™¤ï¼‰
            git checkout -B $branch || git checkout $branch
            git merge --strategy-option ours upstream/$UPSTREAM_BRANCH || true
            git checkout upstream/$UPSTREAM_BRANCH -- .

            # ç»Ÿè®¡æ–°å¢å’Œä¿®æ”¹æ–‡ä»¶
            git add .
            ADDED=$(git diff --cached --name-status | grep "^A" | wc -l)
            MODIFIED=$(git diff --cached --name-status | grep "^M" | wc -l)

            if [ "$ADDED" -eq 0 ] && [ "$MODIFIED" -eq 0 ]; then
              echo "â„¹ï¸ $folder æ²¡æœ‰æ–°å¢æˆ–ä¿®æ”¹æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
            else
              echo "ğŸ“Š $folder å˜æ›´ç»Ÿè®¡ï¼šæ–°å¢ $ADDED ä¸ªï¼Œä¿®æ”¹ $MODIFIED ä¸ª"
              git commit -m "ğŸ”„ åŒæ­¥ $folderï¼ˆå¿½ç•¥åˆ é™¤ï¼‰"
              git push -u origin $branch
              echo "âœ… $folder åŒæ­¥å®Œæˆ"
            fi

            cd ..
          done <<< "$FOLDER_REPO"