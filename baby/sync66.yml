name: Multi-Folder Upstream Sync

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© UTC 0 ç‚¹è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥æƒé™
    env:
      # æ˜ å°„å…³ç³»ï¼šfolder,ä¸Šæ¸¸repo,ä¸Šæ¸¸åˆ†æ”¯,ç›®æ ‡repo,ç›®æ ‡åˆ†æ”¯
      FOLDER_UPSTREAM_REPO: |
        è‡ªå·±ç›®å½•åç§°,https://github.com/ä¸Šæ¸¸è·¯å¾„.git,main,è‡ªå·±çš„åº“è·¯å¾„,main
        cs1,https://github.com/blackmatrix7/ios_rule_script.git,master,coco-coc/gg,main

    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v3

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: åŒæ­¥ä¸Šæ¸¸å†…å®¹
        run: |
          echo "$FOLDER_UPSTREAM_REPO" | grep . | while IFS=',' read -r folder upstream_repo upstream_branch target_repo target_branch; do
            echo "ğŸ”„ åŒæ­¥ $folder ..."
            
            # 1. å…‹éš†ä¸Šæ¸¸ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
            echo "ğŸ“¥ å…‹éš†ä¸Šæ¸¸ä»“åº“åˆ°ä¸´æ—¶ç›®å½•..."
            temp_dir=$(mktemp -d)
            git clone --depth 1 --branch "$upstream_branch" "$upstream_repo" "$temp_dir"
            
            # 2. ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼Œåªæ–°å¢å’Œä¿®æ”¹ï¼Œå¿½ç•¥åˆ é™¤
            echo "ğŸšš ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼Œå¿½ç•¥åˆ é™¤..."
            mkdir -p "$folder"
            # æ ¸å¿ƒå‘½ä»¤ï¼š-av åªæ›´æ–°å˜åŒ–çš„æ–‡ä»¶ï¼Œ--exclude='.git/' å¿½ç•¥ .git ç›®å½•
            rsync -av --exclude='.git/' "$temp_dir"/ "$folder"/

            # 3. æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$temp_dir"
            
            echo "âœ… æ–‡ä»¶å¤¹ $folder å†…å®¹å·²æ›´æ–°"

          done
      
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ”¹åŠ¨ï¼Œå¦‚æœæœ‰åˆ™æ¨é€
          if git status --porcelain | grep .; then
            git add .
            git commit -m "ğŸ”„ åŒæ­¥ä¸Šæ¸¸æ›´æ–°" || echo "â„¹ï¸ æ— æ–°æäº¤"
            git push origin "$GITHUB_REF"
            echo "âœ… æ‰€æœ‰æ›´æ”¹å·²æ¨é€åˆ°ç›®æ ‡ä»“åº“"
          else
            echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ¨é€"
          fi